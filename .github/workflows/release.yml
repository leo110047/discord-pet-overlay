name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: --target aarch64-apple-darwin
          - platform: macos-latest
            args: --target x86_64-apple-darwin
          - platform: windows-latest
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Install frontend dependencies
        run: npm ci

      - name: Build and upload to release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ''
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Discord Pet Overlay ${{ github.ref_name }}'
          releaseBody: |
            ## 更新內容

            ### ${{ github.ref_name }}
            - 新增應用程式內更新功能
            - 修正 Windows 上調整寵物垂直位置無效的問題

            ---

            **macOS 用戶請注意**：由於應用程式未經 Apple 簽名，首次安裝後需要到「系統偏好設定 > 安全性與隱私」允許執行，或是按住 Control 鍵點擊應用程式選擇「打開」。
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

  publish:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Generate latest.json and publish release
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const tag = context.ref.replace('refs/tags/', '');
            const version = tag.replace('v', '');

            // Find the draft release
            const releases = await github.rest.repos.listReleases({ owner, repo });
            const draftRelease = releases.data.find(r => r.draft && r.tag_name === tag);

            if (!draftRelease) {
              console.log(`No draft release found for ${tag}`);
              return;
            }

            console.log(`Found draft release: ${draftRelease.name}`);
            console.log(`Release assets:`);

            // Get all assets
            const assets = await github.rest.repos.listReleaseAssets({
              owner,
              repo,
              release_id: draftRelease.id,
              per_page: 100
            });

            // Find signature files
            let darwinAarch64Sig = '';
            let darwinX64Sig = '';
            let windowsSig = '';

            for (const asset of assets.data) {
              console.log(`  - ${asset.name}`);

              if (asset.name.endsWith('.sig')) {
                // Download signature content
                const response = await github.request('GET /repos/{owner}/{repo}/releases/assets/{asset_id}', {
                  owner,
                  repo,
                  asset_id: asset.id,
                  headers: {
                    Accept: 'application/octet-stream'
                  }
                });

                const sigContent = Buffer.from(response.data).toString('utf-8').trim();
                console.log(`    Signature length: ${sigContent.length}`);

                if (asset.name.includes('aarch64') && asset.name.includes('.app.tar.gz.sig')) {
                  darwinAarch64Sig = sigContent;
                  console.log(`    -> darwin-aarch64`);
                } else if ((asset.name.includes('x64') || asset.name.includes('x86_64')) && asset.name.includes('.app.tar.gz.sig')) {
                  darwinX64Sig = sigContent;
                  console.log(`    -> darwin-x86_64`);
                } else if (asset.name.includes('.nsis.zip.sig')) {
                  windowsSig = sigContent;
                  console.log(`    -> windows-x86_64`);
                }
              }
            }

            // Find updater bundle URLs
            let darwinAarch64Url = '';
            let darwinX64Url = '';
            let windowsUrl = '';

            for (const asset of assets.data) {
              if (asset.name.includes('aarch64') && asset.name.endsWith('.app.tar.gz')) {
                darwinAarch64Url = asset.browser_download_url;
              } else if ((asset.name.includes('x64') || asset.name.includes('x86_64')) && asset.name.endsWith('.app.tar.gz')) {
                darwinX64Url = asset.browser_download_url;
              } else if (asset.name.endsWith('.nsis.zip')) {
                windowsUrl = asset.browser_download_url;
              }
            }

            console.log(`\nURLs found:`);
            console.log(`  darwin-aarch64: ${darwinAarch64Url}`);
            console.log(`  darwin-x86_64: ${darwinX64Url}`);
            console.log(`  windows-x86_64: ${windowsUrl}`);

            // Create latest.json
            const latestJson = {
              version: version,
              notes: `v${version} 更新`,
              pub_date: new Date().toISOString(),
              platforms: {
                'darwin-aarch64': {
                  signature: darwinAarch64Sig,
                  url: darwinAarch64Url
                },
                'darwin-x86_64': {
                  signature: darwinX64Sig,
                  url: darwinX64Url
                },
                'windows-x86_64': {
                  signature: windowsSig,
                  url: windowsUrl
                }
              }
            };

            console.log(`\nlatest.json:`);
            console.log(JSON.stringify(latestJson, null, 2));

            // Upload latest.json as release asset
            const fs = require('fs');
            const latestJsonPath = '/tmp/latest.json';
            fs.writeFileSync(latestJsonPath, JSON.stringify(latestJson, null, 2));

            // Check if latest.json already exists
            const existingLatestJson = assets.data.find(a => a.name === 'latest.json');
            if (existingLatestJson) {
              await github.rest.repos.deleteReleaseAsset({
                owner,
                repo,
                asset_id: existingLatestJson.id
              });
              console.log('Deleted existing latest.json');
            }

            // Upload new latest.json
            const latestJsonContent = fs.readFileSync(latestJsonPath);
            await github.rest.repos.uploadReleaseAsset({
              owner,
              repo,
              release_id: draftRelease.id,
              name: 'latest.json',
              data: latestJsonContent
            });
            console.log('Uploaded latest.json');

            // Publish the release
            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: draftRelease.id,
              draft: false
            });
            console.log(`Published release ${tag}`);
